<!DOCTYPE html><html lang="ja"><head><title>fastifyでstreamを配信する時生のnode/httpに書き込むとResponse Headerが書き込まれなくなる問題 | shinyaigeek.dev</title><meta charset="utf8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta property="og:title" content="fastifyでstreamを配信する時生のnode/httpに書き込むとResponse Headerが書き込まれなくなる問題 | shinyaigeek.dev"><meta property="og:site_name" content="shinyaigeek.dev"><meta property="og:locale" content="ja_JP"><meta name="description" content="見習いWeb developer兼大学生のブログ. 主にweb開発の知見について喋ります"><meta property="og:description" content="見習いWeb developer兼大学生のブログ. 主にweb開発の知見について喋ります"><meta property="og:url" content="https://shinyaigeek.dev/post/fatsify-header-with-raw-write-to-node-http-on-stream"><meta name="twitter:site" content="@shinyaigeek"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://shinyaigeek-og-image.vercel.app/api/?title=fastify%E3%81%A7stream%E3%82%92%E9%85%8D%E4%BF%A1%E3%81%99%E3%82%8B%E6%99%82%E7%94%9F%E3%81%AEnode%2Fhttp%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80%E3%81%A8Response%20Header%E3%81%8C%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C"><meta name="twitter:image" content="https://shinyaigeek-og-image.vercel.app/api/?title=fastify%E3%81%A7stream%E3%82%92%E9%85%8D%E4%BF%A1%E3%81%99%E3%82%8B%E6%99%82%E7%94%9F%E3%81%AEnode%2Fhttp%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80%E3%81%A8Response%20Header%E3%81%8C%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%AA%E3%81%8F%E3%81%AA%E3%82%8B%E5%95%8F%E9%A1%8C"><link rel="icon" type="image/x-icon" href="https://shinyaigeek.dev/assets/static/favicon.ico"><link rel="stylesheet" type="text/css" href="https://shinyaigeek.dev/styles.205c4d88ce50e5b652fc.css"><link rel="stylesheet" type="text/css" href="https://shinyaigeek.dev/a11y-dark.min.css"><link rel="stylesheet" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="style" href="https://shinyaigeek.dev/a11y-dark.min.css"><link rel="preload" as="style" href="https://shinyaigeek.dev/styles.205c4d88ce50e5b652fc.css"><link rel="preload" as="style" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="image" href="https://shinyaigeek.dev/assets/static/icon_transparent_header.png"><link rel="alternate" type="application/rss+xml" title="shinyaigeek.dev" href="https://shinyaigeek.dev/rss.xml"></head><body><div id="_app"><div class="r5xxgyg"><div class="hxs2oc3"><div class="t15f2u4l"><a href="/" class="link2Home"><div><img src="/assets/static/icon_transparent_header.png" alt="icon" class="ib360hc" width="36px" height="36px">shinyaigeek.dev</div></a></div><div class="c1508669"><div class="aondxz7"><a href="/" class="link2Home">Blog</a></div><div class="aondxz7"><a href="/profile" id="link2profile">Profile</a></div><div class="aondxz7"><a href="https://github-activity.shinyaigeek.dev/" id="link2activity">Activity</a></div><div class="aondxz7"><a href="mailto:me@shinyaigeek.dev">Contact</a></div></div></div><div class="iqwsz9a"><div><details class="p1cxnigz"><summary class="post--anchor__title" id="post--anchor__title">目次</summary><a href="#2__0">TL:DR;</a><a href="#2__1">どんな問題?</a><a href="#2__2">なぜこんなことが生じているのか</a><a href="#2__3">解決策</a><a href="#2__4">終わりに</a><a href="#2__5">参考</a></details><div class="m6cmszt"><h1>fastifyでstreamを配信する時生のnode/httpに書き込むとResponse Headerが書き込まれなくなる問題</h1><div>2021/03/21</div><div class="t1hw9n1v"><div>JavaScript</div><div>Nodejs</div><div>HTTP</div></div></div><div class="p8rsdcs"><h2 id="2__0">TL:DR;</h2>
<p>fastifyの <code>reply.header(key, value)</code> は header に書き込まれるべき key-value を呼び出されたタイミングで HTTP Response に書き込むのではなく, <code>res.send</code> のタイミングで書き込んでいます.
Stream を配信する際, <code>reply.raw.write</code> を呼び出してしまっていると Header は暗黙的に flush されてしまっており書き込めなくなってしまいます.</p>
<p>workaroundとしては, <code>reply.raw.write</code> の前に <code>reply.raw.setHeader</code> を呼び出し header の書き込みを fastify に任せるのではなく自分で担ってしまいこれを回避するのが良さそう.</p>
<h2 id="2__1">どんな問題?</h2>
<p>小ネタです.</p>
<p><a href="https://www.fastify.io/">fastify</a> を利用して stream を配信し, <code>reply.raw/write</code> で body の書き込みをしてしまうと, <code>reply.header()</code> で set した Header が反映されていないというエッジケースを踏んでいました.</p>
<p>具体的な事例を挙げる(ここは飛ばしてもいいです)と, ReactDOM/server の renderToNodeStream を利用して stream を配信することで読み込み速度の向上を図っていました.
しかしその場合生成されるマークアップには <code>&lt;!DOCTYPE html&gt;</code> が含まれていません.
<code>DOCTYPE</code> を指定することで, ブラウザがクオークモードで動作することを防ぐことができます. <a href="#refer-1">[1]</a>
できることならばこの <code>DOCTYPE</code> も含めて配信したいですが, renderToNodeStream から返ってくる Readable Stream にこの String 値を書き込むのは当然厳しいため, workaraund的に node/http の response.write で DOCTYPE を書き込んでいました.
fastify だと <code>Reply.raw</code> で node の <code>http.ServerResponse</code> にアクセスし直接 header や body を書き込むことができます. <a href="#refer-2">[2]</a>
一方 ETag や Cache-Control を書き込むために <code>Reply.headers()</code> を利用しますが, これで書き込んだはずの header field が反映されていないということが起きました.</p>
<p>エッジケース of エッジケースという感じがしますね.</p>
<p>再現レポは https://github.com/Shinyaigeek/test-fasity-header/blob/master/main.js ここで可能です, <code>/stream_prefix</code> にアクセスすると <code>res.header()</code> で set したはずの <code>Content-Type: text/html</code> が set されておらず text/plain として表示されることがわかります. これは直感に反しますね.
<code>/stream_prefix_raw</code> にアクセスすると, しっかり　text/html として表示されることがわかります.
これと <code>/stream_prefix</code> との違いは Header の set を fastify に任せているか <code>node/http</code> にアクセスして自分でやってるかだけです.</p>
<h2 id="2__2">なぜこんなことが生じているのか</h2>
<p>fastify が Response Header を書き込むタイミングが <code>reply.header()</code> が呼ばれたタイミングではなく, <code>reply.send(body)</code> が呼ばれ body が配信される直前であることに起因しています.</p>
<p>https://github.com/fastify/fastify/blob/master/lib/reply.js#L222 (2021/3/21時点)</p>
<pre><code class="language-javascript"><span class="hljs-title class_">Reply</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">header</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) {
  <span class="hljs-keyword">const</span> _key = key.<span class="hljs-title function_">toLowerCase</span>()

  <span class="hljs-comment">// default the value to &#x27;&#x27;</span>
  value = value === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">&#x27;&#x27;</span> : value

  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>[kReplyHeaders][_key] &amp;&amp; _key === <span class="hljs-string">&#x27;set-cookie&#x27;</span>) {
    <span class="hljs-comment">// https://tools.ietf.org/html/rfc7230#section-3.2.2</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] === <span class="hljs-string">&#x27;string&#x27;</span>) {
      <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] = [<span class="hljs-variable language_">this</span>[kReplyHeaders][_key]]
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
      <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>[kReplyHeaders][_key], value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>[kReplyHeaders][_key].<span class="hljs-title function_">push</span>(value)
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] = value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
}
</code></pre>
<p>fastify の <code>reply.header</code> の処理を見ると, これが呼ばれたタイミングで <code>http/ServerResponse</code> に書き込んでいるのではなく, <code>this[kReplyHeaders]</code> に格納しているということがわかります.</p>
<p>ではどのタイミングで <code>http/ServerResponse</code> に書き込んでいるかというと, <code>reply.send</code> が呼ばれると <code>onSendHook</code> という関数が呼ばれます. その中でユーザー定義の hook 関数があればそれを呼び出した後, なければ直ちに <code>onSendEnd</code> という関数を呼びます.
その中で header や body の書き込みが行われます.</p>
<p>https://github.com/fastify/fastify/blob/master/lib/reply.js#L391
(見やすいように一部割愛しています)</p>
<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onSendEnd</span> (reply, payload) {
  <span class="hljs-keyword">const</span> res = reply.<span class="hljs-property">raw</span>
  <span class="hljs-keyword">const</span> req = reply.<span class="hljs-property">request</span>
  <span class="hljs-keyword">const</span> statusCode = res.<span class="hljs-property">statusCode</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> payload.<span class="hljs-property">pipe</span> === <span class="hljs-string">&#x27;function&#x27;</span>) {
    <span class="hljs-title function_">sendStream</span>(payload, res, reply)
    <span class="hljs-keyword">return</span>
  }

  reply[kReplySent] = <span class="hljs-literal">true</span>

  res.<span class="hljs-title function_">writeHead</span>(statusCode, reply[kReplyHeaders])

  res.<span class="hljs-title function_">end</span>(payload, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
}
</code></pre>
<p>payload が stream であるときはそれを <code>sendStream</code> に引き渡し, そうでないときは　<code>reply.header()</code> で書き込んだ <code>kreplyHeaders</code> を元に Header を書き込んでから payload を配信していることがわかります.
stream でないときは Header が書き込まれるのは <code>reply.header()</code> が呼ばれたタイミングではなく payload が配信される直前であることがわかりました.</p>
<p>では <code>sendStream</code> の処理ものぞいてみましょう.</p>
<p>https://github.com/fastify/fastify/blob/master/lib/reply.js#L444
(見やすいように一部割愛しています)</p>
<pre><code class="language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendStream</span> (payload, res, reply) {

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">headersSent</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> reply[kReplyHeaders]) {
      res.<span class="hljs-title function_">setHeader</span>(key, reply[kReplyHeaders][key])
    }
  }
  payload.<span class="hljs-title function_">pipe</span>(res)
}
</code></pre>
<p><code>res.headersSent</code> が false であれば Headerを書き込んでから, そうでなければ直ちに stream である payload に <code>http/ServerResponse</code> を pipe することで stream を配信しています.</p>
<p>ここまで書けば大体の人がお気づきかと思いますが, 冒頭の</p>
<blockquote>
<p><a href="https://www.fastify.io/">fastify</a> を利用して stream を配信し, <code>reply.raw/write</code> で body の書き込みをしてしまうと, <code>reply.header()</code> で set した Header が反映されていないというエッジケースを踏んでいました.</p>
</blockquote>
<p>の問題は <code>res.headersSent</code> が true なため生じていました.</p>
<p>なぜそうなるかというと, <code>reply.raw</code> から　<code>http/ServerResponse</code> にアクセスし, <code>reply.raw.write</code> を呼び出して body を書き込んでしまうと Header は暗黙的に flush されてしまい書き込めなくなってしまいます, Header -&gt; Body であることを考えるとある種当たり前のことですね. <a href="#refer-3">[3]</a></p>
<h2 id="2__3">解決策</h2>
<p>fastify にPRを出すという形での根本的な解決を図るアプローチは思いつかず, workaround 的に <code>reply.send</code>, <code>reply.raw.write</code> を呼び出す前に <code>reply.raw.setHeader</code> から Header を書き込んでしまうというので解決できました.
ただこの方法だとheaderをfastifyが内部的にキャッシュしてくれなくなるのがちょっと辛い...
(ちょっと辛いからなんとかしたい...)</p>
<pre><code class="language-javascript">
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">getMarkupStream</span>();

  <span class="hljs-comment">// res.header(&quot;hoge&quot;, &quot;asdf&quot;) </span>
  res.<span class="hljs-property">raw</span>.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&quot;hoge&quot;</span>, <span class="hljs-string">&quot;asdf&quot;</span>);

  res.<span class="hljs-property">raw</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">&quot;&lt;!DOCTYPE html&gt;&quot;</span>);

  res.<span class="hljs-title function_">send</span>(stream);
})

</code></pre>
<h2 id="2__4">終わりに</h2>
<p>マサカリ待ってます :pray:</p>
<h2 id="2__5">参考</h2>
<ul>
<li>* <p id="refer-1">\[1] Page lacks the HTML doctype, thus triggering quirks mode (https://web.dev/doctype/) 閲覧日: 2020/3/21</p>
* <p id="refer-2">\[2] Fastify Docs Reply .raw (https://www.fastify.io/docs/latest/Reply/#raw) 閲覧日: 2020/3/21</p>
* <p id="refer-3">\[3] node http ServerResponse write (https://nodejs.org/api/http.html#http_response_write_chunk_encoding_callback) 閲覧日: 2020/3/21</p></li>
</ul>
</div><div class="i1vwknbf"><div class="m1cfivxx"><img src="/assets/static/icon_transparent.png" class="m1gtmmy1" alt="monkey-icon" width="270px" height="270px"></div><div class="e1l513qn"><div class="e1goj3hq"><div class="eiko6kt"><img src="/assets/static/earth.png" alt="earth" width="50px" height="50px"></div></div></div></div><div class="baseprofile"><div class="njjupn">Shinobu Hayashi a.k.a Shinyaigeek(しにゃい)</div><div class="j15lqbo8" data-text="Web Developer">Web Developer</div><div class="w11bhc9z">I Love and Development Web Technology and that&#x27;s ecosystem!!</div><div class="m6tsee8"><div class="s11qrd2e"><a id="twitter" href="https://twitter.com/Shinyaigeek"><img src="/assets/static/twitter.svg" alt="twitter" width="54px" height="54px"></a></div><div class="s11qrd2e"><a id="github" href="https://github.com/Shinyaigeek"><img src="/assets/static/github.svg" alt="github" width="54px" height="54px"></a></div><div class="s11qrd2e"><a id="linkedin" href="https://www.linkedin.com/in/shinyaigeek/"><img src="/assets/static/linkedin.svg" alt="linkedin" width="54px" height="54px"></a></div></div></div></div></div><div class="fxlvuz3">Copyright. 2020 Shinyaigeek</div></div></div></body><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;0893ac88cf0542af88bfd9b93008b408&quot;, &quot;spa&quot;: true}"></script><script defer="" src="https://shinyaigeek.dev/r.505b1eebe770374f3371.js" async=""></script></html>