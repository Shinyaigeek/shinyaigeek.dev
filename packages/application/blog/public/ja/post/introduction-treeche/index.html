<!DOCTYPE html><html lang="ja"><head><title>Treeche, Tree-Shakable Checker for JavaScript/TypeScript Application to reduce bundle size | shinyaigeek.dev</title><meta charset="utf8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta property="og:title" content="Treeche, Tree-Shakable Checker for JavaScript/TypeScript Application to reduce bundle size | shinyaigeek.dev"><meta property="og:site_name" content="shinyaigeek.dev"><meta property="og:locale" content="ja_JP"><meta name="description" content="Web が好きなオタクのブログ. 主にweb開発の知見について喋ります"><meta property="og:description" content="Web が好きなオタクのブログ. 主にweb開発の知見について喋ります"><meta property="og:url" content="https://shinyaigeek.dev/ja/post/introduction-treeche"><meta name="twitter:site" content="@shinyaigeek"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://ja.shinyaigeek.dev/assets/ogimage/ja/introduction-treeche.png"><meta name="twitter:image" content="https://ja.shinyaigeek.dev/assets/ogimage/ja/introduction-treeche.png"><link rel="icon" type="image/x-icon" href="/assets/static/favicon.ico"><link rel="stylesheet" type="text/css" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="stylesheet" type="text/css" href="/assets/static/a11y-dark.min.css"><link rel="stylesheet" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="style" href="/assets/static/a11y-dark.min.css"><link rel="preload" as="style" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="preload" as="style" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="image" href="/assets/static/icon_transparent_header.png"><link rel="alternate" type="application/rss+xml" title="shinyaigeek.dev" href="/rss.xml"></head><body><div id="_app"><div class="fmapAu0fpx364Dzl_9z0"><div class="J2e3WZniL57BvLtita5T"><div class="kVHiWHyN1gv5Y41SpACy"><a href="/" class="link2Home"><div><img src="/assets/static/icon_transparent_header.png" alt="icon" class="vwQ8HQPKPoICc2atrDju" width="36px" height="36px">shinyaigeek.dev</div></a></div><div class="hOkVSJvM823tjX0FjgO_"><div class="FpNMxf5Gx0pwkDBdeqif"><details><summary> <span role="img" aria-label="language"><g-emoji fallback-src="/assets/static/earth_africa.png" alias="earth">🌍</g-emoji></span> 日本語</summary><div class="ZAVxrSvsXSeI9pV9Rbax"><a href="http://ja.shinyaigeek.dev/post/introduction-treeche" class="aYFqAG93sRJ7BJMCPjsa undefined"><span role="img" aria-label="country"><g-emoji fallback-src="/assets/static/jp.png" alias="Japan">🇯🇵</g-emoji></span>日本語</a><a href="https://en.shinyaigeek.dev/post/introduction-treeche" class="aYFqAG93sRJ7BJMCPjsa"><span role="img" aria-label="country"><span><g-emoji fallback-src="/assets/static/us.png" alias="America">🇺🇸</g-emoji><g-emoji fallback-src="/assets/static/gb.png" alias="United States">🇬🇧</g-emoji></span></span>English</a></div></details></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/" class="link2Home">Blog</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/profile" id="link2profile">Profile</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="https://github-activity.shinyaigeek.dev/" id="link2activity">Activity</a></div></div></div><div class="sxaQUUuymSmhNwqAMaks"><div><details class="h0AHqg9AmVXjXCnYqFqc"><summary class="post--anchor__title" id="post--anchor__title">目次</summary><a href="#2__0">Treeche とは？</a><a href="#2__1">Example</a><a href="#2__2">JavaScript の module バンドルにおいて副作用とは何なのか</a><a href="#2__3">なぜ副作用で bundle-size が大きくなるのか？</a><a href="#2__4">How to use?</a><a href="#2__5">オプション</a><a href="#2__6">動作原理は？</a><a href="#2__7">Feedback</a></details><div class="Y8c8TlU3k_Y72ndSGmnk"><h1>Treeche, Tree-Shakable Checker for JavaScript/TypeScript Application to reduce bundle size</h1><div>2022/08/27</div><div class="BYkaTwWlH4C2pP1hi2JY"><div>Programming</div><div>JavaScript</div><div>DX</div><div>Frontend</div></div></div><div class="L6tHhpo3uw534DnsakEH"><h2 id="2__0">Treeche とは？</h2>
<p>Treecheとは、<strong>Tree</strong> -Shakable <strong>Che</strong> ckerの略です. JavaScript/TypeScript module が Tree-Shakable かどうかを確認するためのツールです. バンドルサイズの削減やそれによるUserExperienceの最適化に有用です.</p>
<p><a href="https://github.com/Shinyaigeek/treeche">https://github.com/Shinyaigeek/treeche</a></p>
<h2 id="2__1">Example</h2>
<pre><code class="hljs language-typescript"><span class="hljs-comment">// this is not tree-shakable because have side-effect</span>

<span class="hljs-keyword">const</span> currentYear = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getFullYear</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentYear</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Year <span class="hljs-subst">${currentYear}</span>`</span>
}
</code></pre>
<p>上記のような module は副作用を有しているため, tree-shakable ではありません。</p>
<p>このような場合、Treeche は以下のような出力をします.</p>
<pre><code class="hljs language-shell">🚨 ~/application/side_effect.ts is not tree-shakable due to the following code:


const currentYear = new Date().getFullYear();
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre>
<p>下記のように, 副作用のある module を副作用のない module に修正して</p>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentYear</span>(<span class="hljs-params">currentDate: <span class="hljs-built_in">Date</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Year <span class="hljs-subst">${currentDate.getFullYear()}</span>`</span>
}
</code></pre>
<p>treeche を実行すると下記のような出力がなされます.</p>
<pre><code class="hljs language-shell">Congratulation 🎉 All files are tree-shakeable ✨
</code></pre>
<h2 id="2__2">JavaScript の module バンドルにおいて副作用とは何なのか</h2>
<p>ECMAScript のモジュールコンテキストにおける副作用とは, module の外部に影響を与えるコードのことを指します. 例えば、以下のようにモジュールのトップレベルで <code>window</code> オブジェクトに変数を設定するのは副作用です. module は import 時に実行されるため, module の top-level で <code>window</code> オブジェクトなどに mutation が加えられていると, module の import 時に実行される必要があります.</p>
<pre><code class="hljs language-javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">m</span> = <span class="hljs-number">1</span>;
<span class="hljs-keyword">export</span> <span class="hljs-title function_">mod</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}
</code></pre>
<p>もちろん, この処理が <code>init</code> のような module から export される関数の中で実行された場合は, import 時にこれが実行されないので、副作用はなくなります。</p>
<h2 id="2__3">なぜ副作用で bundle-size が大きくなるのか？</h2>
<p>rollup の REPL で bundler の挙動を確認することができます。</p>
<p>URL: <a href="https://rollupjs.org/repl/?version=2.78.1&#x26;shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMGhvZ2UlMjAlN0QlMjBmcm9tJTIwJTVDJTIyLiUyRm1vZCU1QyUyM">https://rollupjs.org/repl/?version=2.78.1&#x26;shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMGhvZ2UlMjAlN0QlMjBmcm9tJTIwJTVDJTIyLiUyRm1vZCU1QyUyMiUzQiU1Q24lNUNuY29uc29sZS5sb2coaG9nZSgpKSUyMiUyQyUyMmlzRW50cnklMjIlM0F0cnVlJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMm1vZC5qcyUyMiUyQyUyMmNvZGUlMjIlM0ElMjJleHBvcnQlMjBmdW5jdGlvbiUyMGhvZ2UoKSUyMCU3QiU1Q24lNUN0cmV0dXJuJTIwMSUzQiU1Q24lN0QlNUNuJTVDbmV4cG9ydCUyMGZ1bmN0aW9uJTIwZnVnYSgpJTIwJTdCJTVDbiU1Q3RyZXR1cm4lMjBuZXclMjBEYXRlKCkuZ2V0RnVsbFllYXIoKSUzQiU1Q24lN0QlMjIlN0QlNUQlMkMlMjJvcHRpb25zJTIyJTNBJTdCJTIyZm9ybWF0JTIyJTNBJTIyZXMlMjIlMkMlMjJuYW1lJTIyJTNBJTIybXlCdW5kbGUlMjIlMkMlMjJhbWQlMjIlM0ElN0IlMjJpZCUyMiUzQSUyMiUyMiU3RCUyQyUyMmdsb2JhbHMlMjIlM0ElN0IlN0QlN0QlMkMlMjJleGFtcGxlJTIyJTNBbnVsbCU3RA==</a></p>
<p><strong>main.js</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">import</span> { hoge } <span class="hljs-keyword">from</span> <span class="hljs-string">"./mod"</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hoge</span>())
</code></pre>
<p><strong>mod.js</strong></p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hoge</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fuga</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getFullYear</span>();
}
</code></pre>
<p>上記のようなコードを rollup で bundle した結果は以下のようになります.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hoge</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hoge</span>());
</code></pre>
<p><code>mod.js</code> 内の <code>fuga</code> 関数が bundle の結果に存在しないのは, bundler が <code>main.js</code> が <code>fuga</code> 関数をインポートしていない(そしてもちろん使っていない)ことを知っているからで, そのため <code>fuga</code> 関数をバンドル出力に含める必要がなく, バンドルサイズの減少につながります。</p>
<p>しかし以下のように <code>mod.js</code> を編集するとどうなるでしょう.</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hoge</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">const</span> _fuga = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getFullYear</span>();

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fuga</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> _fuga;
}
</code></pre>
<p>バンドルされた出力は、上記のようになります。</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hoge</span>(<span class="hljs-params"></span>) {
	<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getFullYear</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hoge</span>());
</code></pre>
<p><a href="https://rollupjs.org/repl/?version=2.78.1&#x26;shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMGhvZ">https://rollupjs.org/repl/?version=2.78.1&#x26;shareable=JTdCJTIybW9kdWxlcyUyMiUzQSU1QiU3QiUyMm5hbWUlMjIlM0ElMjJtYWluLmpzJTIyJTJDJTIyY29kZSUyMiUzQSUyMmltcG9ydCUyMCU3QiUyMGhvZ2UlMjAlN0QlMjBmcm9tJTIwJTVDJTIyLiUyRm1vZCU1QyUyMiUzQiU1Q24lNUNuY29uc29sZS5sb2coaG9nZSgpKSUyMiUyQyUyMmlzRW50cnklMjIlM0F0cnVlJTdEJTJDJTdCJTIybmFtZSUyMiUzQSUyMm1vZC5qcyUyMiUyQyUyMmNvZGUlMjIlM0ElMjJleHBvcnQlMjBmdW5jdGlvbiUyMGhvZ2UoKSUyMCU3QiU1Q24lNUN0cmV0dXJuJTIwMSUzQiU1Q24lN0QlNUNuJTVDbmNvbnN0JTIwX2Z1Z2ElMjAlM0QlMjBuZXclMjBEYXRlKCkuZ2V0RnVsbFllYXIoKSUzQiU1Q24lNUNuZXhwb3J0JTIwZnVuY3Rpb24lMjBmdWdhKCklMjAlN0IlNUNuJTVDdHJldHVybiUyMF9mdWdhJTNCJTVDbiU3RCUyMiU3RCU1RCUyQyUyMm9wdGlvbnMlMjIlM0ElN0IlMjJmb3JtYXQlMjIlM0ElMjJlcyUyMiUyQyUyMm5hbWUlMjIlM0ElMjJteUJ1bmRsZSUyMiUyQyUyMmFtZCUyMiUzQSU3QiUyMmlkJTIyJTNBJTIyJTIyJTdEJTJDJTIyZ2xvYmFscyUyMiUzQSU3QiU3RCU3RCUyQyUyMmV4YW1wbGUlMjIlM0FudWxsJTdE</a></p>
<p>バンドルされている出力に不要な <code>new Date().getFullYear()</code> が含まれていることを確認できますね. なぜなら <code>mod.js</code> が <code>new Date().getFullYear()</code> という副作用を孕むからです. JavaScript では、import されたモジュールは import 時に実行されるので、<code>new Date().getFullYear()</code> のような副作用のあるコードはそもそも実行されるべきであるため, bundler が削除することができません. しかしそもそも <code>fuga</code> 関数を import しないのであれば、<code>new Date().getFullYear()</code> がバンドルされた出力に含まれる必要はありません. なぜなら、もう一方の関数 <code>hoge</code> は <code>const _fuga = new Date().getFullYear()</code> を必要としないためです. なので理想としては <code>new Date().getFullYear()</code> というコードが出力からなくなっているべきです.</p>
<h2 id="2__4">How to use?</h2>
<p>Treecheをグローバルインストールして使うのみです.</p>
<pre><code class="hljs language-shell">npm install treeche -g
treeche "**/*.ts" --excludes "node_modules" "**/*.test.ts"
</code></pre>
<p>argument に入力のファイルを取ることができます. ここには Node glob pattern を利用することができます. また <code>--excludes</code> option で, 特定のファイル, フォルダを除外することができます. test ファイルや node_modules はノイズになるのでこれを用いて除外することが想定されています. また argument を省略した上で, <code>--entry-point</code> で単一のファイルを指定すると, そこを entrypoint として bundle した上で, その上で副作用があるかチェックしてくれます.</p>
<h2 id="2__5">オプション</h2>





























<table><thead><tr><th align="center">kind</th><th align="center">name</th><th align="center">description</th><th align="center">example</th></tr></thead><tbody><tr><td align="center">argument</td><td align="center">inputs</td><td align="center">input files to check tree-shakable. you can use Node glob pattern</td><td align="center">treeche "src/**/*.ts"</td></tr><tr><td align="center">option</td><td align="center">excludes</td><td align="center">excludes files to filter from inputs. you can use Node glob pattern</td><td align="center">treeche "src/**/*.ts" --e "node_modules"</td></tr><tr><td align="center">option</td><td align="center">entry point</td><td align="center">the unique entry point to check tree-shakable. if you specify input with this, treeche will bundle so you can check tree-shakable also in node_modules</td><td align="center">treeche --entry-point ./src/main.ts</td></tr></tbody></table>
<h2 id="2__6">動作原理は？</h2>
<p>動作原理はとても単純で, Treeche は JavaScript module bundler である rollup を内部で実行し、下記のように option で指定した入力モジュールを import している仮想エントリポイントコードをバンドルします。</p>
<pre><code class="hljs language-javascript">
<span class="hljs-keyword">import</span>  <span class="hljs-string">"./your-module"</span>

</code></pre>
<p>"./your-module" に副作用がある場合, import 以外のコードも出力されます. それをチェックしています.</p>
<h2 id="2__7">Feedback</h2>
<p>これは欲しいと思ってサクッと作った試験的なものですので, 多分バグがあります. 先に謝っておきます. バグや要望などあればフィードバックいただけると嬉しいです！</p></div><div class="XTxSDCE1gmhoF59UaA7g"><div class="mdGYkZO2YHxhxRXU338z"><div class="O6UishUpXe8xGlTrCl8G"><img src="/assets/static/icon_transparent.png" class="J5UgGRYhWe9JWeYlm2bw" alt="monkey-icon" width="270px" height="270px"></div><div class="cab8_7jeBIe5dRHd8ikS"><div class="kEage_DVZV_Stt0z3eAT"><div class="_5U8hWpqU834VUiKxwCpA"><img src="/assets/static/earth.png" alt="earth" width="50px" height="50px"></div></div></div></div><div class="baseprofile"><div class="_pakeuUKwDGIGV1PIDFI">Hi <span role="img" aria-label="wave hand">👋</span> I&#x27;m <span class="zQUgJkaqGKzVRFrvk7mk">Shinobu Hayashi a.k.a Shinyaigeek(しにゃい)</span>.</div><div class="CMC6WyjhCeKfvY5zyyq0"><span data-text="Web Developer" class="v7yavk2O9dr3NZXn186P">Web Developer</span> <g-emoji fallback-src="/assets/static/spider_web.png" alias="spider-web">🕸</g-emoji> / <span data-text="Reliable web Enthusiast" class="v7yavk2O9dr3NZXn186P">Reliable Web Enthusiast</span> <g-emoji fallback-src="/assets/static/fire.png" alias="fire">🔥</g-emoji> </div><div class="gA7tXpIz5V3YPffc9WIr">Faster, Lighter, More accessible, More secure, More productive Web for anyone, anytime , anywhere.</div><div class="v0ZqRqZjlqevKrsWtDTt"><div class="zdvavtYkqc1dXYPR1y0c"><a id="twitter" href="https://twitter.com/Shinyaigeek"><img src="/assets/static/twitter.svg" alt="twitter" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="github" href="https://github.com/Shinyaigeek"><img src="/assets/static/github.svg" alt="github" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="linkedin" href="https://www.linkedin.com/in/shinyaigeek/"><img src="/assets/static/linkedin.svg" alt="linkedin" width="54px" height="54px"></a></div></div><div class="l5KzSvykijElHJc7q2c9"><a href="mailto:me@shinyaigeek.dev">Contact Me on Email <g-emoji fallback-src="/assets/static/email.png" alias="email">📧</g-emoji></a></div></div></div></div></div><div class="AJQSVdi_FHylcHDbYLWV">Copyright. 2022 Shinyaigeek</div></div></div></body><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;0893ac88cf0542af88bfd9b93008b408&quot;, &quot;spa&quot;: true}"></script><script defer="" src="/assets/r.a0d01c88f547277aab5a.js" async=""></script></html>