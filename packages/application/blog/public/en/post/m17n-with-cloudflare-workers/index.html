<!DOCTYPE html><html lang="en"><head><title>m17n with cloudflare workers | shinyaigeek.dev</title><meta charset="utf8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta property="og:title" content="m17n with cloudflare workers | shinyaigeek.dev"><meta property="og:site_name" content="shinyaigeek.dev"><meta property="og:locale" content="ja_JP"><meta name="description" content="Web „ÅåÂ•Ω„Åç„Å™„Ç™„Çø„ÇØ„ÅÆ„Éñ„É≠„Ç∞. ‰∏ª„Å´webÈñãÁô∫„ÅÆÁü•Ë¶ã„Å´„Å§„ÅÑ„Å¶Âñã„Çä„Åæ„Åô"><meta property="og:description" content="Web „ÅåÂ•Ω„Åç„Å™„Ç™„Çø„ÇØ„ÅÆ„Éñ„É≠„Ç∞. ‰∏ª„Å´webÈñãÁô∫„ÅÆÁü•Ë¶ã„Å´„Å§„ÅÑ„Å¶Âñã„Çä„Åæ„Åô"><meta property="og:url" content="https://shinyaigeek.dev/en/post/m17n-with-cloudflare-workers"><meta name="twitter:site" content="@shinyaigeek"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://en.shinyaigeek.dev/assets/ogimage/en/m17n-with-cloudflare-workers.png"><meta name="twitter:image" content="https://en.shinyaigeek.dev/assets/ogimage/en/m17n-with-cloudflare-workers.png"><link rel="icon" type="image/x-icon" href="/assets/static/favicon.ico"><link rel="stylesheet" type="text/css" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="stylesheet" type="text/css" href="/assets/static/a11y-dark.min.css"><link rel="stylesheet" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="style" href="/assets/static/a11y-dark.min.css"><link rel="preload" as="style" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="preload" as="style" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="image" href="/assets/static/icon_transparent_header.png"><link rel="alternate" type="application/rss+xml" title="shinyaigeek.dev" href="/rss.xml"></head><body><div id="_app"><div class="fmapAu0fpx364Dzl_9z0"><div class="J2e3WZniL57BvLtita5T"><div class="kVHiWHyN1gv5Y41SpACy"><a href="/" class="link2Home"><div><img src="/assets/static/icon_transparent_header.png" alt="icon" class="vwQ8HQPKPoICc2atrDju" width="36px" height="36px">shinyaigeek.dev</div></a></div><div class="hOkVSJvM823tjX0FjgO_"><div class="FpNMxf5Gx0pwkDBdeqif"><details><summary> <span role="img" aria-label="language"><g-emoji fallback-src="/assets/static/earth_africa.png" alias="earth">üåç</g-emoji></span> English</summary><div class="ZAVxrSvsXSeI9pV9Rbax"><a href="http://ja.shinyaigeek.dev/post/m17n-with-cloudflare-workers" class="aYFqAG93sRJ7BJMCPjsa"><span role="img" aria-label="country"><g-emoji fallback-src="/assets/static/jp.png" alias="Japan">üáØüáµ</g-emoji></span>Êó•Êú¨Ë™û</a><a href="https://en.shinyaigeek.dev/post/m17n-with-cloudflare-workers" class="aYFqAG93sRJ7BJMCPjsa undefined"><span role="img" aria-label="country"><span><g-emoji fallback-src="/assets/static/us.png" alias="America">üá∫üá∏</g-emoji><g-emoji fallback-src="/assets/static/gb.png" alias="United States">üá¨üáß</g-emoji></span></span>English</a></div></details></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/" class="link2Home">Blog</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/profile" id="link2profile">Profile</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="https://github-activity.shinyaigeek.dev/" id="link2activity">Activity</a></div></div></div><div class="sxaQUUuymSmhNwqAMaks"><div><details class="h0AHqg9AmVXjXCnYqFqc"><summary class="post--anchor__title" id="post--anchor__title">Table of Contents</summary><a href="#2__0">shinyaigeek.dev&#x27;s architecture</a><a href="#2__1">where sort according to the &quot;accept-language&quot; of the HTTP Request Header</a><a href="#2__2">How to?</a><a href="#2__3">Impressions</a></details><div class="Y8c8TlU3k_Y72ndSGmnk"><h1>m17n with cloudflare workers</h1><div>2022/02/19</div><div class="BYkaTwWlH4C2pP1hi2JY"><div>Programming</div><div>CDN</div><div>CloudFlare</div></div></div><div class="L6tHhpo3uw534DnsakEH"><p>Hi there! I'm <a href="https://twitter.com/Shinyaigeek">Shinyaigeek(Shinobu Hayashi)</a>. I have been sending Pull Requests for OSS that I am interested in to pass the time, because I have a time till this April. As a result, I have been getting more and more Direct Messages on Twitter from the maintainers or who I have talked on issue or PR or discord, and according to cloudflare's analytics, more HTTP Request was came from foreign countries. Even if I consider about the HTTP Request from crawler bots, I think I should handle these requests. I decided to support English on my blog. I used cloudflare workers for one of the requirements, which is to sort the contents according to the "accept-language" of the HTTP Request Header. I got it right and had a good experience with just few working, so I thought I'd write this article as a note.</p>
<h2 id="2__0">shinyaigeek.dev's architecture</h2>
<p>I start to describe shinyaigeek.dev's architecture. In shinyaigeek.dev, the components are written in JSX, and the articles are written in markdown. I used the handmade static site builder to convert JSX and markdown into HTML, and serve the output from h2o server on VPS in Japan. I don't need complex functionalities on my blog and I think there are few page transitions, so I don't use hydration of <code>react-dom</code>, so shinyaigeek.dev works without React on client. There are some parts that use JavaScript functionalities, but all of them are encapsulated in customElements.</p>
<h2 id="2__1">where sort according to the "accept-language" of the HTTP Request Header</h2>
<p>First of all, I had the two options, to change the HTTP Response contents according to HTTP Request "accept-language" header on the same URL or to send HTTP 301 Response. I chosen the latter, redirect because I think in the former way, the shared-cache will be troublesome. If I rewrite HTTP Request's URL with cloudflare workers, we won't have to worry about it, but since it is a static blog, I did not want to send a different content for requests to the same URL, so I chose the latter. In order to redirect a client which send an HTTP Request, I need to return HTTP 301 Response, which can be returned from the origin server or cloudflare workers. Sending HTTP 301 Response from the origin server will cause delay due to geographic factors, especially I thought many of the user, the target of this multilingual support, send HTTP Request from the countries outside of Japan, so I decided to use cloudflare workers to handle this at the network edge in order to eliminate such delay.</p>
<h2 id="2__2">How to?</h2>
<p>It was easy. There is some libraries which parses "accept-language" and determine preferred language, all I have to do is to choose the most appropriate one and use it.</p>
<ul>
<li><a href="https://www.npmjs.com/package/accept-language">accept-language</a></li>
<li><a href="https://www.npmjs.com/package/accept-language-parser">accept-language-parser</a></li>
<li><a href="https://www.npmjs.com/package/resolve-accept-language">resolve-accept-language</a></li>
</ul>
<p>points to make note of:</p>
<ul>
<li>Don't do anything for HTTP Requests for other than HTML file.</li>
<li>In this case, I make HTTP Request which URL ends of <code>.html</code> or <code>/</code> target of this process.</li>
<li>Be careful of infinite loop</li>
<li>If you redirect to a page for en, and the client sends an HTTP Request in response, the following cloudflare workers will be fired again, and you will be redirected to a page for en again. This can be an infinite loop.</li>
<li>In shinyaigeek.dev, pages for "en" and "ja" are on different domains, so cloudflare workers are not fired when HTTP requests are sent to those domains. This is partly to prevent the infinite loop mentioned above, but also because people who access these URLs may want to read them in that language regardless of the accept-language.</li>
<li>For example, if you are using a pathname with a prefix such as <code>/en/</code> instead of a subdomain, you should be careful.</li>
</ul>
<p>The following is a simple code:</p>
<h3>„Ç≥„Éº„Éâ</h3>
<pre><code class="hljs language-typescript"><span class="hljs-keyword">import</span> resolveAcceptLanguage <span class="hljs-keyword">from</span> <span class="hljs-string">'resolve-accept-language'</span>

<span class="hljs-keyword">const</span> handler = <span class="hljs-keyword">function</span> (<span class="hljs-params">event: FetchEvent</span>) {
  <span class="hljs-comment">// get URL from HTTP Request</span>
  <span class="hljs-keyword">const</span> { url } = event.<span class="hljs-property">request</span>
  <span class="hljs-comment">// get pathname and search query from HTTP Request</span>
  <span class="hljs-keyword">const</span> { pathname, search } = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url)

  <span class="hljs-comment">// Don't anything if the HTTP Request is not for HTML file</span>
  <span class="hljs-keyword">if</span> (!pathname.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.html'</span>) &#x26;&#x26; !pathname.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'/'</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
  }

  <span class="hljs-comment">//  get accept-language from HTTP Request Header</span>
  <span class="hljs-keyword">const</span> acceptLanguage = event.<span class="hljs-property">request</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'accept-language'</span>)
  <span class="hljs-keyword">if</span> (!acceptLanguage) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
  }
  <span class="hljs-comment">// determine preferred language</span>
  <span class="hljs-keyword">const</span> preferredLanguage = <span class="hljs-title function_">resolveAcceptLanguage</span>(
    acceptLanguage,
    [<span class="hljs-string">'en-US'</span>, <span class="hljs-string">'ja-JP'</span>],
    <span class="hljs-string">'ja-JP'</span>,
  )

  <span class="hljs-comment">// if english is prefered, return HTTP 301 response</span>
  <span class="hljs-keyword">if</span> (preferedLanguage === <span class="hljs-string">'en-US'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>.<span class="hljs-title function_">redirect</span>(
      <span class="hljs-string">`https://en.shinyaigeek.dev<span class="hljs-subst">${pathname}</span><span class="hljs-subst">${search}</span>`</span>,
      <span class="hljs-number">301</span>,
    )
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
}

<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =></span> {
  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handler</span>(event))
})
</code></pre>
<h2 id="2__3">Impressions</h2>
<p>Since I'm making a blog without using any framework, I have to think about this kind of multi-language support by myself, but it's fun to train myself. Also, recently, cloudflare workers and Compute@Edge have made it possible for front-end engineers to quickly control things like reverse proxy using familiar JS, which is a great time. Also, since we are doing this by force without using any frameworks, we would appreciate it if you could tell us if we should actually do this or that.</p></div><div class="XTxSDCE1gmhoF59UaA7g"><div class="mdGYkZO2YHxhxRXU338z"><div class="O6UishUpXe8xGlTrCl8G"><img src="/assets/static/icon_transparent.png" class="J5UgGRYhWe9JWeYlm2bw" alt="monkey-icon" width="270px" height="270px"></div><div class="cab8_7jeBIe5dRHd8ikS"><div class="kEage_DVZV_Stt0z3eAT"><div class="_5U8hWpqU834VUiKxwCpA"><img src="/assets/static/earth.png" alt="earth" width="50px" height="50px"></div></div></div></div><div class="baseprofile"><div class="_pakeuUKwDGIGV1PIDFI">Hi <span role="img" aria-label="wave hand">üëã</span> I&#x27;m <span class="zQUgJkaqGKzVRFrvk7mk">Shinobu Hayashi a.k.a Shinyaigeek(„Åó„Å´„ÇÉ„ÅÑ)</span>.</div><div class="CMC6WyjhCeKfvY5zyyq0"><span data-text="Web Developer" class="v7yavk2O9dr3NZXn186P">Web Developer</span> <g-emoji fallback-src="/assets/static/spider_web.png" alias="spider-web">üï∏</g-emoji> / <span data-text="Reliable web Enthusiast" class="v7yavk2O9dr3NZXn186P">Reliable Web Enthusiast</span> <g-emoji fallback-src="/assets/static/fire.png" alias="fire">üî•</g-emoji> </div><div class="gA7tXpIz5V3YPffc9WIr">Faster, Lighter, More accessible, More secure, More productive Web for anyone, anytime , anywhere.</div><div class="v0ZqRqZjlqevKrsWtDTt"><div class="zdvavtYkqc1dXYPR1y0c"><a id="twitter" href="https://twitter.com/Shinyaigeek"><img src="/assets/static/twitter.svg" alt="twitter" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="github" href="https://github.com/Shinyaigeek"><img src="/assets/static/github.svg" alt="github" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="linkedin" href="https://www.linkedin.com/in/shinyaigeek/"><img src="/assets/static/linkedin.svg" alt="linkedin" width="54px" height="54px"></a></div></div><div class="l5KzSvykijElHJc7q2c9"><a href="mailto:me@shinyaigeek.dev">Contact Me on Email <g-emoji fallback-src="/assets/static/email.png" alias="email">üìß</g-emoji></a></div></div></div></div></div><div class="AJQSVdi_FHylcHDbYLWV">Copyright. 2022 Shinyaigeek</div></div></div></body><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;0893ac88cf0542af88bfd9b93008b408&quot;, &quot;spa&quot;: true}"></script><script defer="" src="/assets/r.a0d01c88f547277aab5a.js" async=""></script></html>