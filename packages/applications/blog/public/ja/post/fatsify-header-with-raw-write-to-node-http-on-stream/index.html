<!DOCTYPE html><html lang="ja"><head><title>fastifyã§streamã‚’é…ä¿¡ã™ã‚‹æ™‚ç”Ÿã®node/httpã«æ›¸ãè¾¼ã‚€ã¨Response HeaderãŒæ›¸ãè¾¼ã¾ã‚Œãªããªã‚‹å•é¡Œ | shinyaigeek.dev</title><meta charset="utf8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta property="og:title" content="fastifyã§streamã‚’é…ä¿¡ã™ã‚‹æ™‚ç”Ÿã®node/httpã«æ›¸ãè¾¼ã‚€ã¨Response HeaderãŒæ›¸ãè¾¼ã¾ã‚Œãªããªã‚‹å•é¡Œ | shinyaigeek.dev"><meta property="og:site_name" content="shinyaigeek.dev"><meta property="og:locale" content="ja_JP"><meta name="description" content="Web ãŒå¥½ããªã‚ªã‚¿ã‚¯ã®ãƒ–ãƒ­ã‚°. ä¸»ã«webé–‹ç™ºã®çŸ¥è¦‹ã«ã¤ã„ã¦å–‹ã‚Šã¾ã™"><meta property="og:description" content="Web ãŒå¥½ããªã‚ªã‚¿ã‚¯ã®ãƒ–ãƒ­ã‚°. ä¸»ã«webé–‹ç™ºã®çŸ¥è¦‹ã«ã¤ã„ã¦å–‹ã‚Šã¾ã™"><meta property="og:url" content="https://shinyaigeek.dev/ja/post/fatsify-header-with-raw-write-to-node-http-on-stream"><meta name="twitter:site" content="@shinyaigeek"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://ja.shinyaigeek.dev/assets/ogimage/ja/fatsify-header-with-raw-write-to-node-http-on-stream.png"><meta name="twitter:image" content="https://ja.shinyaigeek.dev/assets/ogimage/ja/fatsify-header-with-raw-write-to-node-http-on-stream.png"><link rel="icon" type="image/x-icon" href="/assets/static/favicon.ico"><link rel="stylesheet" type="text/css" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="stylesheet" type="text/css" href="/assets/static/a11y-dark.min.css"><link rel="stylesheet" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="style" href="/assets/static/a11y-dark.min.css"><link rel="preload" as="style" href="/assets/styles.ada9902fc362b01889c3.css"><link rel="preload" as="style" href="https://unpkg.com/github-calendar@latest/dist/github-calendar-responsive.css"><link rel="preload" as="image" href="/assets/static/icon_transparent_header.png"><link rel="alternate" type="application/rss+xml" title="shinyaigeek.dev" href="/rss.xml"></head><body><div id="_app"><div class="fmapAu0fpx364Dzl_9z0"><div class="J2e3WZniL57BvLtita5T"><div class="kVHiWHyN1gv5Y41SpACy"><a href="/" class="link2Home"><div><img src="/assets/static/icon_transparent_header.png" alt="icon" class="vwQ8HQPKPoICc2atrDju" width="36px" height="36px">shinyaigeek.dev</div></a></div><div class="hOkVSJvM823tjX0FjgO_"><div class="FpNMxf5Gx0pwkDBdeqif"><details><summary> <span role="img" aria-label="language"><g-emoji fallback-src="/assets/static/earth_africa.png" alias="earth">ğŸŒ</g-emoji></span> æ—¥æœ¬èª</summary><div class="ZAVxrSvsXSeI9pV9Rbax"><a href="http://ja.shinyaigeek.dev/post/fatsify-header-with-raw-write-to-node-http-on-stream" class="aYFqAG93sRJ7BJMCPjsa undefined"><span role="img" aria-label="country"><g-emoji fallback-src="/assets/static/jp.png" alias="Japan">ğŸ‡¯ğŸ‡µ</g-emoji></span>æ—¥æœ¬èª</a><a href="https://en.shinyaigeek.dev/post/fatsify-header-with-raw-write-to-node-http-on-stream" class="aYFqAG93sRJ7BJMCPjsa"><span role="img" aria-label="country"><span><g-emoji fallback-src="/assets/static/us.png" alias="America">ğŸ‡ºğŸ‡¸</g-emoji><g-emoji fallback-src="/assets/static/gb.png" alias="United States">ğŸ‡¬ğŸ‡§</g-emoji></span></span>English</a></div></details></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/" class="link2Home">Blog</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="/profile" id="link2profile">Profile</a></div><div class="FpNMxf5Gx0pwkDBdeqif"><a href="https://github-activity.shinyaigeek.dev/" id="link2activity">Activity</a></div></div></div><div class="sxaQUUuymSmhNwqAMaks"><div><details class="h0AHqg9AmVXjXCnYqFqc"><summary class="post--anchor__title" id="post--anchor__title">ç›®æ¬¡</summary><a href="#2__0">TL:DR;</a><a href="#2__1">ã©ã‚“ãªå•é¡Œ?</a><a href="#2__2">ãªãœã“ã‚“ãªã“ã¨ãŒç”Ÿã˜ã¦ã„ã‚‹ã®ã‹</a><a href="#2__3">è§£æ±ºç­–</a><a href="#2__4">çµ‚ã‚ã‚Šã«</a><a href="#2__5">å‚è€ƒ</a></details><div class="Y8c8TlU3k_Y72ndSGmnk"><h1>fastifyã§streamã‚’é…ä¿¡ã™ã‚‹æ™‚ç”Ÿã®node/httpã«æ›¸ãè¾¼ã‚€ã¨Response HeaderãŒæ›¸ãè¾¼ã¾ã‚Œãªããªã‚‹å•é¡Œ</h1><div>2021/03/21</div><div class="BYkaTwWlH4C2pP1hi2JY"><div>JavaScript</div><div>Nodejs</div><div>HTTP</div></div></div><div class="L6tHhpo3uw534DnsakEH"><h2 id="2__0">TL:DR;</h2>
<p>fastifyã® <code>reply.header(key, value)</code> ã¯ header ã«æ›¸ãè¾¼ã¾ã‚Œã‚‹ã¹ã key-value ã‚’å‘¼ã³å‡ºã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ HTTP Response ã«æ›¸ãè¾¼ã‚€ã®ã§ã¯ãªã, <code>res.send</code> ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™.
Stream ã‚’é…ä¿¡ã™ã‚‹éš›, <code>reply.raw.write</code> ã‚’å‘¼ã³å‡ºã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã¨ Header ã¯æš—é»™çš„ã« flush ã•ã‚Œã¦ã—ã¾ã£ã¦ãŠã‚Šæ›¸ãè¾¼ã‚ãªããªã£ã¦ã—ã¾ã„ã¾ã™.</p>
<p>workaroundã¨ã—ã¦ã¯, <code>reply.raw.write</code> ã®å‰ã« <code>reply.raw.setHeader</code> ã‚’å‘¼ã³å‡ºã— header ã®æ›¸ãè¾¼ã¿ã‚’ fastify ã«ä»»ã›ã‚‹ã®ã§ã¯ãªãè‡ªåˆ†ã§æ‹…ã£ã¦ã—ã¾ã„ã“ã‚Œã‚’å›é¿ã™ã‚‹ã®ãŒè‰¯ã•ãã†.</p>
<h2 id="2__1">ã©ã‚“ãªå•é¡Œ?</h2>
<p>å°ãƒã‚¿ã§ã™.</p>
<p><a href="https://www.fastify.io/">fastify</a> ã‚’åˆ©ç”¨ã—ã¦ stream ã‚’é…ä¿¡ã—, <code>reply.raw/write</code> ã§ body ã®æ›¸ãè¾¼ã¿ã‚’ã—ã¦ã—ã¾ã†ã¨, <code>reply.header()</code> ã§ set ã—ãŸ Header ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’è¸ã‚“ã§ã„ã¾ã—ãŸ.</p>
<p>å…·ä½“çš„ãªäº‹ä¾‹ã‚’æŒ™ã’ã‚‹(ã“ã“ã¯é£›ã°ã—ã¦ã‚‚ã„ã„ã§ã™)ã¨, ReactDOM/server ã® renderToNodeStream ã‚’åˆ©ç”¨ã—ã¦ stream ã‚’é…ä¿¡ã™ã‚‹ã“ã¨ã§èª­ã¿è¾¼ã¿é€Ÿåº¦ã®å‘ä¸Šã‚’å›³ã£ã¦ã„ã¾ã—ãŸ.
ã—ã‹ã—ãã®å ´åˆç”Ÿæˆã•ã‚Œã‚‹ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã«ã¯ <code>&#x3C;!DOCTYPE html></code> ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“.
<code>DOCTYPE</code> ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§, ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚¯ã‚ªãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™. <a href="#refer-1">[1]</a>
ã§ãã‚‹ã“ã¨ãªã‚‰ã°ã“ã® <code>DOCTYPE</code> ã‚‚å«ã‚ã¦é…ä¿¡ã—ãŸã„ã§ã™ãŒ, renderToNodeStream ã‹ã‚‰è¿”ã£ã¦ãã‚‹ Readable Stream ã«ã“ã® String å€¤ã‚’æ›¸ãè¾¼ã‚€ã®ã¯å½“ç„¶å³ã—ã„ãŸã‚, workaraundçš„ã« node/http ã® response.write ã§ DOCTYPE ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã¾ã—ãŸ.
fastify ã ã¨ <code>Reply.raw</code> ã§ node ã® <code>http.ServerResponse</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ç›´æ¥ header ã‚„ body ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã™. <a href="#refer-2">[2]</a>
ä¸€æ–¹ ETag ã‚„ Cache-Control ã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã« <code>Reply.headers()</code> ã‚’åˆ©ç”¨ã—ã¾ã™ãŒ, ã“ã‚Œã§æ›¸ãè¾¼ã‚“ã ã¯ãšã® header field ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã“ã¨ãŒèµ·ãã¾ã—ãŸ.</p>
<p>ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ of ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã¨ã„ã†æ„Ÿã˜ãŒã—ã¾ã™ã­.</p>
<p>å†ç¾ãƒ¬ãƒã¯ <a href="https://github.com/Shinyaigeek/test-fasity-header/blob/master/main.js">https://github.com/Shinyaigeek/test-fasity-header/blob/master/main.js</a> ã“ã“ã§å¯èƒ½ã§ã™, <code>/stream_prefix</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ <code>res.header()</code> ã§ set ã—ãŸã¯ãšã® <code>Content-Type: text/html</code> ãŒ set ã•ã‚Œã¦ãŠã‚‰ãš text/plain ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™. ã“ã‚Œã¯ç›´æ„Ÿã«åã—ã¾ã™ã­.
<code>/stream_prefix_raw</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨, ã—ã£ã‹ã‚Šã€€text/html ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™.
ã“ã‚Œã¨ <code>/stream_prefix</code> ã¨ã®é•ã„ã¯ Header ã® set ã‚’ fastify ã«ä»»ã›ã¦ã„ã‚‹ã‹ <code>node/http</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦è‡ªåˆ†ã§ã‚„ã£ã¦ã‚‹ã‹ã ã‘ã§ã™.</p>
<h2 id="2__2">ãªãœã“ã‚“ãªã“ã¨ãŒç”Ÿã˜ã¦ã„ã‚‹ã®ã‹</h2>
<p>fastify ãŒ Response Header ã‚’æ›¸ãè¾¼ã‚€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒ <code>reply.header()</code> ãŒå‘¼ã°ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ãªã, <code>reply.send(body)</code> ãŒå‘¼ã°ã‚Œ body ãŒé…ä¿¡ã•ã‚Œã‚‹ç›´å‰ã§ã‚ã‚‹ã“ã¨ã«èµ·å› ã—ã¦ã„ã¾ã™.</p>
<p><a href="https://github.com/fastify/fastify/blob/master/lib/reply.js#L222">https://github.com/fastify/fastify/blob/master/lib/reply.js#L222</a> (2021/3/21æ™‚ç‚¹)</p>
<pre><code class="hljs language-javascript"><span class="hljs-title class_">Reply</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">header</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">key, value</span>) {
  <span class="hljs-keyword">const</span> _key = key.<span class="hljs-title function_">toLowerCase</span>()

  <span class="hljs-comment">// default the value to ''</span>
  value = value === <span class="hljs-literal">undefined</span> ? <span class="hljs-string">''</span> : value

  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>[kReplyHeaders][_key] &#x26;&#x26; _key === <span class="hljs-string">'set-cookie'</span>) {
    <span class="hljs-comment">// https://tools.ietf.org/html/rfc7230#section-3.2.2</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] === <span class="hljs-string">'string'</span>) {
      <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] = [<span class="hljs-variable language_">this</span>[kReplyHeaders][_key]]
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
      <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">push</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>[kReplyHeaders][_key], value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>[kReplyHeaders][_key].<span class="hljs-title function_">push</span>(value)
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>[kReplyHeaders][_key] = value
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
}
</code></pre>
<p>fastify ã® <code>reply.header</code> ã®å‡¦ç†ã‚’è¦‹ã‚‹ã¨, ã“ã‚ŒãŒå‘¼ã°ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ <code>http/ServerResponse</code> ã«æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã®ã§ã¯ãªã, <code>this[kReplyHeaders]</code> ã«æ ¼ç´ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™.</p>
<p>ã§ã¯ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ <code>http/ServerResponse</code> ã«æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã‹ã¨ã„ã†ã¨, <code>reply.send</code> ãŒå‘¼ã°ã‚Œã‚‹ã¨ <code>onSendHook</code> ã¨ã„ã†é–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã™. ãã®ä¸­ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã® hook é–¢æ•°ãŒã‚ã‚Œã°ãã‚Œã‚’å‘¼ã³å‡ºã—ãŸå¾Œ, ãªã‘ã‚Œã°ç›´ã¡ã« <code>onSendEnd</code> ã¨ã„ã†é–¢æ•°ã‚’å‘¼ã³ã¾ã™.
ãã®ä¸­ã§ header ã‚„ body ã®æ›¸ãè¾¼ã¿ãŒè¡Œã‚ã‚Œã¾ã™.</p>
<p><a href="https://github.com/fastify/fastify/blob/master/lib/reply.js#L391">https://github.com/fastify/fastify/blob/master/lib/reply.js#L391</a>
(è¦‹ã‚„ã™ã„ã‚ˆã†ã«ä¸€éƒ¨å‰²æ„›ã—ã¦ã„ã¾ã™)</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onSendEnd</span> (reply, payload) {
  <span class="hljs-keyword">const</span> res = reply.<span class="hljs-property">raw</span>
  <span class="hljs-keyword">const</span> req = reply.<span class="hljs-property">request</span>
  <span class="hljs-keyword">const</span> statusCode = res.<span class="hljs-property">statusCode</span>

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> payload.<span class="hljs-property">pipe</span> === <span class="hljs-string">'function'</span>) {
    <span class="hljs-title function_">sendStream</span>(payload, res, reply)
    <span class="hljs-keyword">return</span>
  }

  reply[kReplySent] = <span class="hljs-literal">true</span>

  res.<span class="hljs-title function_">writeHead</span>(statusCode, reply[kReplyHeaders])

  res.<span class="hljs-title function_">end</span>(payload, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)
}
</code></pre>
<p>payload ãŒ stream ã§ã‚ã‚‹ã¨ãã¯ãã‚Œã‚’ <code>sendStream</code> ã«å¼•ãæ¸¡ã—, ãã†ã§ãªã„ã¨ãã¯ã€€<code>reply.header()</code> ã§æ›¸ãè¾¼ã‚“ã  <code>kreplyHeaders</code> ã‚’å…ƒã« Header ã‚’æ›¸ãè¾¼ã‚“ã§ã‹ã‚‰ payload ã‚’é…ä¿¡ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™.
stream ã§ãªã„ã¨ãã¯ Header ãŒæ›¸ãè¾¼ã¾ã‚Œã‚‹ã®ã¯ <code>reply.header()</code> ãŒå‘¼ã°ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¯ãªã payload ãŒé…ä¿¡ã•ã‚Œã‚‹ç›´å‰ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸ.</p>
<p>ã§ã¯ <code>sendStream</code> ã®å‡¦ç†ã‚‚ã®ãã„ã¦ã¿ã¾ã—ã‚‡ã†.</p>
<p><a href="https://github.com/fastify/fastify/blob/master/lib/reply.js#L444">https://github.com/fastify/fastify/blob/master/lib/reply.js#L444</a>
(è¦‹ã‚„ã™ã„ã‚ˆã†ã«ä¸€éƒ¨å‰²æ„›ã—ã¦ã„ã¾ã™)</p>
<pre><code class="hljs language-javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendStream</span> (payload, res, reply) {

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">headersSent</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> reply[kReplyHeaders]) {
      res.<span class="hljs-title function_">setHeader</span>(key, reply[kReplyHeaders][key])
    }
  }
  payload.<span class="hljs-title function_">pipe</span>(res)
}
</code></pre>
<p><code>res.headersSent</code> ãŒ false ã§ã‚ã‚Œã° Headerã‚’æ›¸ãè¾¼ã‚“ã§ã‹ã‚‰, ãã†ã§ãªã‘ã‚Œã°ç›´ã¡ã« stream ã§ã‚ã‚‹ payload ã« <code>http/ServerResponse</code> ã‚’ pipe ã™ã‚‹ã“ã¨ã§ stream ã‚’é…ä¿¡ã—ã¦ã„ã¾ã™.</p>
<p>ã“ã“ã¾ã§æ›¸ã‘ã°å¤§ä½“ã®äººãŒãŠæ°—ã¥ãã‹ã¨æ€ã„ã¾ã™ãŒ, å†’é ­ã®</p>
<blockquote>
<p><a href="https://www.fastify.io/">fastify</a> ã‚’åˆ©ç”¨ã—ã¦ stream ã‚’é…ä¿¡ã—, <code>reply.raw/write</code> ã§ body ã®æ›¸ãè¾¼ã¿ã‚’ã—ã¦ã—ã¾ã†ã¨, <code>reply.header()</code> ã§ set ã—ãŸ Header ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã‚’è¸ã‚“ã§ã„ã¾ã—ãŸ.</p>
</blockquote>
<p>ã®å•é¡Œã¯ <code>res.headersSent</code> ãŒ true ãªãŸã‚ç”Ÿã˜ã¦ã„ã¾ã—ãŸ.</p>
<p>ãªãœãã†ãªã‚‹ã‹ã¨ã„ã†ã¨, <code>reply.raw</code> ã‹ã‚‰ã€€<code>http/ServerResponse</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—, <code>reply.raw.write</code> ã‚’å‘¼ã³å‡ºã—ã¦ body ã‚’æ›¸ãè¾¼ã‚“ã§ã—ã¾ã†ã¨ Header ã¯æš—é»™çš„ã« flush ã•ã‚Œã¦ã—ã¾ã„æ›¸ãè¾¼ã‚ãªããªã£ã¦ã—ã¾ã„ã¾ã™, Header -> Body ã§ã‚ã‚‹ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ã‚ã‚‹ç¨®å½“ãŸã‚Šå‰ã®ã“ã¨ã§ã™ã­. <a href="#refer-3">[3]</a></p>
<h2 id="2__3">è§£æ±ºç­–</h2>
<p>fastify ã«PRã‚’å‡ºã™ã¨ã„ã†å½¢ã§ã®æ ¹æœ¬çš„ãªè§£æ±ºã‚’å›³ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¯æ€ã„ã¤ã‹ãš, workaround çš„ã« <code>reply.send</code>, <code>reply.raw.write</code> ã‚’å‘¼ã³å‡ºã™å‰ã« <code>reply.raw.setHeader</code> ã‹ã‚‰ Header ã‚’æ›¸ãè¾¼ã‚“ã§ã—ã¾ã†ã¨ã„ã†ã®ã§è§£æ±ºã§ãã¾ã—ãŸ.
ãŸã ã“ã®æ–¹æ³•ã ã¨headerã‚’fastifyãŒå†…éƒ¨çš„ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãã‚Œãªããªã‚‹ã®ãŒã¡ã‚‡ã£ã¨è¾›ã„...
(ã¡ã‚‡ã£ã¨è¾›ã„ã‹ã‚‰ãªã‚“ã¨ã‹ã—ãŸã„...)</p>
<pre><code class="hljs language-javascript">
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =></span> {
  <span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">getMarkupStream</span>();

  <span class="hljs-comment">// res.header("hoge", "asdf") </span>
  res.<span class="hljs-property">raw</span>.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"hoge"</span>, <span class="hljs-string">"asdf"</span>);

  res.<span class="hljs-property">raw</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"&#x3C;!DOCTYPE html>"</span>);

  res.<span class="hljs-title function_">send</span>(stream);
})

</code></pre>
<h2 id="2__4">çµ‚ã‚ã‚Šã«</h2>
<p>ãƒã‚µã‚«ãƒªå¾…ã£ã¦ã¾ã™ :pray:</p>
<h2 id="2__5">å‚è€ƒ</h2>
<ul>
<li>
<p id="refer-1">\[1] Page lacks the HTML doctype, thus triggering quirks mode (https://web.dev/doctype/) é–²è¦§æ—¥: 2020/3/21</p>
</li>
<li>
<p id="refer-2">\[2] Fastify Docs Reply .raw (https://www.fastify.io/docs/latest/Reply/#raw) é–²è¦§æ—¥: 2020/3/21</p>
</li>
<li>
<p id="refer-3">\[3] node http ServerResponse write (https://nodejs.org/api/http.html#http_response_write_chunk_encoding_callback) é–²è¦§æ—¥: 2020/3/21</p>
</li>
</ul></div><div class="XTxSDCE1gmhoF59UaA7g"><div class="mdGYkZO2YHxhxRXU338z"><div class="O6UishUpXe8xGlTrCl8G"><img src="/assets/static/icon_transparent.png" class="J5UgGRYhWe9JWeYlm2bw" alt="monkey-icon" width="270px" height="270px"></div><div class="cab8_7jeBIe5dRHd8ikS"><div class="kEage_DVZV_Stt0z3eAT"><div class="_5U8hWpqU834VUiKxwCpA"><img src="/assets/static/earth.png" alt="earth" width="50px" height="50px"></div></div></div></div><div class="baseprofile"><div class="_pakeuUKwDGIGV1PIDFI">Hi <span role="img" aria-label="wave hand">ğŸ‘‹</span> I&#x27;m <span class="zQUgJkaqGKzVRFrvk7mk">Shinobu Hayashi a.k.a Shinyaigeek(ã—ã«ã‚ƒã„)</span>.</div><div class="CMC6WyjhCeKfvY5zyyq0"><span data-text="Web Developer" class="v7yavk2O9dr3NZXn186P">Web Developer</span> <g-emoji fallback-src="/assets/static/spider_web.png" alias="spider-web">ğŸ•¸</g-emoji> / <span data-text="Reliable web Enthusiast" class="v7yavk2O9dr3NZXn186P">Reliable Web Enthusiast</span> <g-emoji fallback-src="/assets/static/fire.png" alias="fire">ğŸ”¥</g-emoji> </div><div class="gA7tXpIz5V3YPffc9WIr">Faster, Lighter, More accessible, More secure, More productive Web for anyone, anytime , anywhere.</div><div class="v0ZqRqZjlqevKrsWtDTt"><div class="zdvavtYkqc1dXYPR1y0c"><a id="twitter" href="https://twitter.com/Shinyaigeek"><img src="/assets/static/twitter.svg" alt="twitter" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="github" href="https://github.com/Shinyaigeek"><img src="/assets/static/github.svg" alt="github" width="54px" height="54px"></a></div><div class="zdvavtYkqc1dXYPR1y0c"><a id="linkedin" href="https://www.linkedin.com/in/shinyaigeek/"><img src="/assets/static/linkedin.svg" alt="linkedin" width="54px" height="54px"></a></div></div><div class="l5KzSvykijElHJc7q2c9"><a href="mailto:me@shinyaigeek.dev">Contact Me on Email <g-emoji fallback-src="/assets/static/email.png" alias="email">ğŸ“§</g-emoji></a></div></div></div></div></div><div class="AJQSVdi_FHylcHDbYLWV">Copyright. 2022 Shinyaigeek</div></div></div></body><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;0893ac88cf0542af88bfd9b93008b408&quot;, &quot;spa&quot;: true}"></script><script defer="" src="/assets/r.a0d01c88f547277aab5a.js" async=""></script></html>